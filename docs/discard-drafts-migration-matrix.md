## Discard-Drafts Migration Creation Matrix

This matrix summarizes the data artifacts produced by the `core::5.0.0-discard-drafts` migration across combinations of localization (i18n), draft/publish (DP), and relation/component states, based on the implementation in `packages/core/core/src/migrations/database/5.0.0-discard-drafts.ts` and its validation tooling (`examples/complex/scripts/validate-migration.js`, `examples/complex/scripts/seed-v4-template.js`).

| i18n status         | source content type DP? | source entry state     | relation / component target DP state                                       | artifact created                                      | effect / notes                                                                                                                                                         | delta vs develop (`discardDraft`)                                                                                                                  |
| ------------------- | ----------------------- | ---------------------- | -------------------------------------------------------------------------- | ----------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| disabled or enabled | yes                     | published (any locale) | n/a                                                                        | new row in source table with `published_at = NULL`    | Stage 1 clones every published entry into a draft. Cloned row carries scalar fields (including `document_id`, locale) but omits relations/components.                  | Same effect (service also cloned via `entries.discardDraft`).                                                                                      |
| enabled             | yes                     | published              | any                                                                        | same as above                                         | When localized, clones occur per document + locale. Latest draft per `(document_id, locale)` is tracked for relation remapping.                                        | Same effect; service reused locale-specific mapping.                                                                                               |
| any                 | yes                     | draft                  | any                                                                        | none                                                  | Existing4 drafts are untouched; migration only acts on published entries.                                                                                              | Same effect; service skipped drafts.                                                                                                               |
| any                 | yes                     | published              | DP target has published version                                            | join-table row (source ↔ target draft)               | `copyRelationsForContentType` / `copyRelationsToOtherContentTypes` duplicate relations so the new draft points at the draft version of the target (self and cross-CT). | Same effect; handled via `unidirectionalRelations.sync`.                                                                                           |
| any                 | yes                     | published              | DP target has draft version                                                | join-table row (source draft ↔ target draft)         | Same as above; target draft ID resolved via target map (latest draft found).                                                                                           | Same effect; service used `transformData` / relation sync.                                                                                         |
| any                 | yes                     | published              | DP target missing draft                                                    | join-table row (source draft ↔ original target id)   | Falls back to published ID when no mapping; preserves relation even if target draft absent.                                                                            | Same effect; service left target untouched when no draft map.                                                                                      |
| any                 | yes                     | published              | target content type lacks DP                                               | join-table row (source draft ↔ existing target)      | Target map absent ⇒ relation copied verbatim.                                                                                                                          | Same effect.                                                                                                                                       |
| any                 | yes                     | published              | DP target referenced via foreign key column (no join table)                | n/a (update-in-place)                                 | Stage 3 rewrites draft row’s FK to the draft target ID when available; no new rows created, existing draft row updated.                                                | Same effect; service created draft rows with transformed FK values.                                                                                |
| any                 | no                      | published              | DP target has draft                                                        | join-table row (non-DP source ↔ draft target)        | `copyRelationsFromOtherContentTypes` inserts supplemental rows so non-DP sources now relate to draft counterparts (duplicates skipped).                                | Same effect; service propagated via `unidirectionalRelations.sync`.                                                                                |
| any                 | no                      | published              | DP target lacks draft                                                      | none                                                  | When no draft exists, relation is left pointing to published target; no new row inserted.                                                                              | Same effect.                                                                                                                                       |
| any                 | yes                     | published              | component instance belongs to content type without DP ancestors            | component table row + join-table row                  | `copyComponentRelations` clones component records (new IDs, timestamps, document IDs) and inserts matching relations pointing to draft entity.                         | Same effect; service cloned components during discard.                                                                                             |
| any                 | yes                     | published              | component instance nested under DP-enabled ancestor component/content type | none                                                  | Hierarchy check filters these relations; avoids duplicating component trees when ancestor already produces its own drafts.                                             | Same effect via `components.createComponentRelationFilter`.                                                                                        |
| any                 | yes                     | published              | component relation to DP target                                            | component join-table row(s) remapped to draft targets | After component clone, nested relations are remapped to draft IDs where possible (uses cached target maps).                                                            | Fixes missing self-referential module links that `discardDraft()` left behind (see [issue #24544](https://github.com/strapi/strapi/issues/24544)). |
| any                 | yes                     | published              | component relation to non-DP target                                        | component join-table row copied as-is                 | Target map missing ⇒ existing IDs retained.                                                                                                                            | Same effect.                                                                                                                                       |
| any                 | yes                     | published              | component lacks further relations                                          | component row only                                    | Only the component row itself is cloned; no additional rows produced.                                                                                                  | Same effect.                                                                                                                                       |

### Stage Overview

- **Stage 1 (`copyPublishedEntriesToDraft`)**: clones all published entries for DP-enabled content types, producing bare draft rows per locale.
- **Stage 2 (`copyRelationsToDrafts` et al.)**: copies join-table relations, supplements non-DP sources, and clones component trees while remapping targets to drafts when possible.
- **Stage 3 (`updateJoinColumnRelations`)**: rewrites foreign-key columns in draft rows to reference draft targets; no new rows are created in this step.
