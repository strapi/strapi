name: 'Publish Prerelease'

on:
  workflow_dispatch:
    inputs:
      dist-tag:
        description: 'The tag you want to publish to NPM'
        default: 'experimental'

permissions:
  id-token: write # Required for npm trusted publishing via GitHub OIDC
  contents: read # Allows the workflow to check out the repository

jobs:
  publish:
    name: 'Publish'
    runs-on: ubuntu-latest

    # Safety check to ensure this workflow only runs on the main Strapi repository
    if: github.repository == 'strapi/strapi'

    steps:
      # Fetch the repository contents
      - uses: actions/checkout@v4

      # Install Node.js and configure npm to use the public npm registry
      # This also wires npm to GitHub OIDC for trusted publishing
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      # Ensure a recent npm version that supports OIDC trusted publishing
      - name: Install compatible npm version
        run: npm install -g npm@11.5.1

      # Install project dependencies
      - run: yarn

      # Run the prerelease publish script
      # IMPORTANT: this script must call `npm publish` (not `yarn publish`)
      - run: ./scripts/pre-publish.sh
        env:
          VERSION: '0.0.0-experimental.${{ github.sha }}'
          DIST_TAG: ${{ github.event.inputs.dist-tag }}
