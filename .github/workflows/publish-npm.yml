name: 'publish-npm.yml'

on:
  workflow_dispatch:
    inputs:
      version:
        type: choice
        description: 'The version you want to publish to NPM'
        options:
          - patch
          - minor
          - prepatch
          - preminor
      tag:
        type: choice
        description: 'NPM dist-tag'
        default: 'experimental'
        options:
          - latest
          - beta
          - rc
          - alpha
          - experimental

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    name: Publish packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: ${{ (inputs.tag == 'experimental') && 1 || 0 }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - run: yarn

      - name: Debug OIDC availability
        run: |
          echo "ACTIONS_ID_TOKEN_REQUEST_URL=${ACTIONS_ID_TOKEN_REQUEST_URL:-<missing>}"
          if [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ]; then
            echo "No ACTIONS_ID_TOKEN_REQUEST_URL available (id-token permission may be missing)"
            exit 0
          fi
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN present: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+yes}"
          # Try requesting an id token for a sample audience. Replace 'npm' with the audience
          # you configured in the npm OIDC trust if needed.
          TOKEN=$(curl -s -X GET "${ACTIONS_ID_TOKEN_REQUEST_URL}?audience=npm" -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}")
          if [ -z "${TOKEN}" ]; then
            echo "Failed to obtain id token (empty response)"
          else
            echo "Obtained id token length: ${#TOKEN}"
            # Try to decode JWT payload to inspect claims (aud, repository, repository_owner)
            PAYLOAD=$(echo "${TOKEN}" | cut -d '.' -f2)
            # Add base64 padding if necessary
            PAD=$((4 - ${#PAYLOAD} % 4))
            if [ "$PAD" -lt 4 ]; then
              PAD_STR=$(printf '%*s' "$PAD" '' | tr ' ' '=')
              PAYLOAD="${PAYLOAD}${PAD_STR}"
            fi
            echo "Decoded ID token payload (raw JSON):"
            echo "${PAYLOAD}" | base64 --decode 2>/dev/null || echo "(failed to base64-decode payload)"
            echo "Attempting pretty-print (jq or python fallback):"
            echo "${PAYLOAD}" | base64 --decode 2>/dev/null | jq . || (echo "jq not available or failed; using python fallback" && echo "${PAYLOAD}" | base64 --decode 2>/dev/null | python3 -c 'import sys,json;print(json.dumps(json.load(sys.stdin),indent=2))') || true
          fi

      - name: Publish packages (run publish scripts)
        env:
          TAG: ${{ inputs.tag }}
          VERSION: ${{ inputs.version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          DIST_TAG="$TAG"

          # Decide flow based on DIST_TAG: experimental => prerelease, otherwise release
          if [ "$DIST_TAG" = "experimental" ]; then
            echo "Running prerelease flow (DIST_TAG=experimental): ./scripts/pre-publish.sh"
            export VERSION='0.0.0-experimental.${{ github.sha }}'
            export DIST_TAG
            ./scripts/pre-publish.sh
          else
            echo "Running release flow: ./scripts/publish.sh (DIST_TAG=$DIST_TAG)"
          fi
